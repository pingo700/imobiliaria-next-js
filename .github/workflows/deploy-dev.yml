name: ğŸ“Ÿ Deploy Development - ImobiliÃ¡ria Sistema

on:
  push:
    branches: [develop]
  workflow_dispatch:

concurrency:
  group: deploy-develop
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-deploy-dev:
    name: ğŸ› ï¸ Build & Deploy to Development
    runs-on: ubuntu-latest
    environment:
      name: develop
      url: ${{ vars.URL }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: â™»ï¸ Restore Next.js cache
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-next-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-next-

      - name: ğŸ“¦ Install Deps
        run: pnpm install --no-frozen-lockfile

      # IMPORTANTE: com output:'export', o build jÃ¡ gera a pasta out/
      - name: ğŸ—ï¸ Build (Next.js - export)
        run: pnpm run build

      - name: ğŸ” Validar export
        run: |
          echo "Raiz do workspace:"
          ls -la
          echo "ConteÃºdo de out/:"
          ls -la out || (echo "âŒ out/ nÃ£o gerado"; exit 1)

      - name: ğŸš€ Deploy via SSH (publicar out/)
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          ARGS: "-rltgoDzvO --delete"
          SOURCE: "out/"   # <<<< AQUI Ã© o grande ajuste
          REMOTE_HOST: ${{ vars.REMOTE_HOST }}
          REMOTE_USER: ${{ vars.REMOTE_USER }}
          REMOTE_PORT: ${{ vars.REMOTE_PORT }}
          TARGET: ${{ vars.TARGET }}

      # OPCIONAL: fallback SPA para rotas nÃ£o geradas (use sÃ³ se precisar)
      # - name: ğŸ”§ .htaccess fallback (opcional)
      #   uses: easingthemes/ssh-deploy@main
      #   with:
      #     SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
      #     ARGS: ""
      #     SOURCE: ""
      #     REMOTE_HOST: ${{ vars.REMOTE_HOST }}
      #     REMOTE_USER: ${{ vars.REMOTE_USER }}
      #     REMOTE_PORT: ${{ vars.REMOTE_PORT }}
      #     TARGET: ${{ vars.TARGET }}
      #     SCRIPT_AFTER: |
      #       cd ${{ vars.TARGET }}
      #       cat > .htaccess <<'HT'
      #       <IfModule mod_rewrite.c>
      #         RewriteEngine On
      #         RewriteCond %{REQUEST_FILENAME} !-f
      #         RewriteCond %{REQUEST_FILENAME} !-d
      #         RewriteRule . /index.html [L]
      #       </IfModule>
      #       HT
